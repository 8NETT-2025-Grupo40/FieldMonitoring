# ExternalSecret: sincroniza secrets do AWS Secrets Manager para Kubernetes
# O External Secrets Operator busca os secrets e cria um Kubernetes Secret
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ include "field-monitoring-api.fullname" . }}-externalsecret
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "field-monitoring-api.labels" . | nindent 4 }}
spec:
  # Refresh automático a cada 1 hora
  refreshInterval: 1h
  
  # SecretStore define como acessar o AWS Secrets Manager
  secretStoreRef:
    name: {{ include "field-monitoring-api.fullname" . }}-secretstore
    kind: SecretStore
  
  # Nome do Kubernetes Secret que será criado
  target:
    name: {{ include "field-monitoring-api.fullname" . }}-secrets
    creationPolicy: Owner
  
  # Mapeamento: AWS Secrets Manager -> Kubernetes Secret
  data:
    # Connection string do SQL Server/RDS
    - secretKey: connectionString
      remoteRef:
        key: {{ .Values.secrets.connectionString.awsSecretName }}
    
    # Token do InfluxDB
    - secretKey: influxDbToken
      remoteRef:
        key: {{ .Values.secrets.influxDbToken.awsSecretName }}
    
    # URL da fila SQS
    - secretKey: sqsQueueUrl
      remoteRef:
        key: {{ .Values.secrets.sqsQueueUrl.awsSecretName }}
    
    # Cognito config (extrai campos do JSON)
    - secretKey: cognitoRegion
      remoteRef:
        key: {{ .Values.secrets.cognitoConfig.awsSecretName }}
        property: region
    
    - secretKey: cognitoUserPoolId
      remoteRef:
        key: {{ .Values.secrets.cognitoConfig.awsSecretName }}
        property: userPoolId
    
    - secretKey: cognitoClientId
      remoteRef:
        key: {{ .Values.secrets.cognitoConfig.awsSecretName }}
        property: clientId
